/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2015 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./Opa','./OpaPlugin','./PageObjectFactory','sap/ui/qunit/QUnitUtils','sap/ui/base/Object','sap/ui/Device','./matchers/Matcher','./matchers/AggregationFilled','./matchers/PropertyStrictEquals','./matchers/Properties','./matchers/Ancestor','./matchers/AggregationContainsPropertyEqual','./everyPolyfill','sap/ui/thirdparty/URI'],function($,O,a,P,U,b,D,M,A,c){var p=new a(),f=null,F=null,o=null,d=null,e=null,g=false,u=false;var h=b.extend("sap.ui.test.Opa5",jQuery.extend({},O.prototype,{constructor:function(){O.apply(this,arguments);}}));function s(S,T){e=$("#OpaFrame");var i=jQuery.sap.getModulePath("sap.ui.test.OpaFrame",".css");jQuery.sap.includeStyleSheet(i);if(!e.length){e=$('<iframe id="OpaFrame" class="opaFrame" src="'+S+'"></iframe>');$("body").append(e);}if(e[0].contentDocument&&e[0].contentDocument.readyState==="complete"){k();}else{e.on("load",k);}return this.waitFor({viewName:null,controlType:null,id:null,searchOpenDialogs:false,check:function(){if(!g){return;}return m();},timeout:T||80,errorMessage:"unable to load the iframe with the url: "+S});}h.iStartMyAppInAFrame=s;h.prototype.iStartMyAppInAFrame=s;function t(){return this.waitFor({success:function(){v();g=false;u=false;}});}h.iTeardownMyAppFrame=t;h.prototype.iTeardownMyAppFrame=t;h.prototype.waitFor=function(i){i=$.extend({},O.config,i);var w=i.check,C=null,x,y=i.success,z,R;i.check=function(){if(!this._modifyControlType(i)){return false;}C=h.getPlugin().getMatchingControls(i);if((i.viewName||i.searchOpenDialogs)&&!i.id&&!C||(C&&C.length===0)){jQuery.sap.log.debug("found no controls in view: "+i.viewName+" with controlType "+i.sOriginalControlType,"","Opa");return false;}if(typeof i.id==="string"&&!C){jQuery.sap.log.debug("found no control with the id "+i.id,"","Opa");return false;}if(i.id instanceof RegExp&&!C.length){jQuery.sap.log.debug("found no control with the id regex"+i.id);return false;}if($.isArray(i.id)&&(!C||C.length!==i.id.length)){if(C&&C.length){jQuery.sap.log.debug("found not all controls with the ids "+i.id+" onlyFound the controls: "+C.map(function(G){return G.sId;}));}else{jQuery.sap.log.debug("found no control with the id  "+i.id);}return false;}if(i.sOriginalControlType&&!C.length){jQuery.sap.log.debug("found no controls with the type  "+i.sOriginalControlType,"","Opa");return false;}x=this._checkMatchers(i.matchers);var E;if(x&&x.length){if(!$.isArray(C)){E=1;z=[C];}else{z=C;}var B=[];z.forEach(function(G){var H=this._doesValueMatch(x,G);if(H){if(H===true){B.push(G);}else{B.push(H);}}},this);if(!B.length){jQuery.sap.log.debug("all results were filtered out by the matchers - skipping the check");return false;}if(E===1){R=B[0];}else{R=B;}}else{R=C;}if(w){return this._executeCheck(w,R);}return true;};if(y){i.success=function(){y.call(this,R);};}return O.prototype.waitFor.call(this,i);};h.getPlugin=function(){return o||p;};h.getJQuery=function(){return F;};h.getWindow=function(){return f;};h.getUtils=function(){return d;};h.getHashChanger=function(){if(!f){return null;}f.jQuery.sap.require("sap.ui.core.routing.HashChanger");return f.sap.ui.core.routing.HashChanger.getInstance();};h.extendConfig=O.extendConfig;h.resetConfig=function(){O.resetConfig();O.extendConfig({viewNamespace:"",arrangements:new h(),actions:new h(),assertions:new h(),visible:true,_stackDropCount:1});};h.emptyQueue=O.emptyQueue;h.matchers={};h.matchers.Matcher=M;h.matchers.AggregationFilled=A;h.matchers.PropertyStrictEquals=c;h.createPageObjects=function(i){return P.create(i,h);};h.prototype._doesValueMatch=function(w,V){var x=V;var I=true;jQuery.each(w,function(i,y){var z=y.isMatching(V);if(z){if(z!==true){V=z;}}else{I=false;return false;}});if(I){return(x===V)?true:V;}else{return false;}};h.prototype._checkMatchers=function(i){var w=[];if($.isArray(i)){w=i;}else if(i){w=[i];}w=w.map(function(x){if(x instanceof h.matchers.Matcher){return x;}else if(typeof x=="function"){return{isMatching:x};}jQuery.sap.log.error("Matchers where defined, but they where neither an array nor a single matcher: "+i);return undefined;}).filter(function(x){return!!x;});return w;};h.prototype._modifyControlType=function(i){var C=i.controlType;if(typeof C!=="string"){return true;}i.sOriginalControlType=C;var w=f||window;var x=w.jQuery.sap.getObject(C);if(!x){jQuery.sap.log.debug("The control type "+C+" is undefined. Skipped check and will wait until it is required",this);return false;}if(x._sapUiLazyLoader){jQuery.sap.log.debug("The control type "+C+" is currently a lazy stub. Skipped check and will wait until it is invoked",this);return false;}i.controlType=x;return true;};h.prototype._executeCheck=function(C,i){jQuery.sap.log.debug("Opa is executing the check: "+C);var R=C.call(this,i);jQuery.sap.log.debug("Opa check was "+R);return R;};h.resetConfig();function j(){F=f.jQuery;r("sap.ui.test");F.sap.require("sap.ui.test.OpaPlugin");o=new f.sap.ui.test.OpaPlugin();r("sap.ui.qunit.QUnitUtils");f.jQuery.sap.require("sap.ui.qunit.QUnitUtils");d=f.sap.ui.qunit.QUnitUtils;}function r(i){var w=jQuery.sap.getModulePath(i);var x=new URI(w).absoluteTo(document.baseURI).search("").toString();F.sap.registerModulePath(i,x);}function k(){f=e[0].contentWindow;l();g=true;m();}function l(){if(D.browser.internet_explorer&&D.browser.version===9){return;}var i=f.onerror;f.onerror=function(E,w,L){if(i){i.apply(this,arguments);}throw"OpaFrame error message: "+E+" url: "+w+" line: "+L;};}function m(){if(u){return true;}if(f&&f.sap&&f.sap.ui&&f.sap.ui.getCore){u=true;n();}return false;}function n(){j();q();}function q(){f.jQuery.sap.require("sap.ui.thirdparty.hasher");f.jQuery.sap.require("sap.ui.core.routing.History");f.jQuery.sap.require("sap.ui.core.routing.HashChanger");var H=new f.sap.ui.core.routing.HashChanger(),i=new f.sap.ui.core.routing.History(H),w=f.hasher,x=w.setHash,y=w.getHash,C,z=f.history.go;w.replaceHash=function(G){var I=this.getHash();C=G;H.fireEvent("hashReplaced",{sHash:G});this.changed.dispatch(G,I);};w.setHash=function(G){var R=y.call(this);C=G;H.fireEvent("hashSet",{sHash:G});x.apply(this,arguments);if(R===this.getHash()){this.changed.dispatch(R,i.aHistory[i.iHistoryPosition]);}};w.getHash=function(){if(C===undefined){return y.apply(this,arguments);}return C;};H.init();function B(){var N=i.aHistory[i.iHistoryPosition],G=i.getPreviousHash();C=G;w.changed.dispatch(G,N);}function E(){var N=i.aHistory[i.iHistoryPosition+1],G=i.aHistory[i.iHistoryPosition];if(N===undefined){jQuery.sap.log.error("Could not navigate forwards, there is no history entry in the forwards direction",this);return;}C=N;w.changed.dispatch(N,G);}f.history.back=B;f.history.forward=E;f.history.go=function(S){if(S===-1){B();return;}else if(S===1){E();return;}jQuery.sap.log.error("Using history.go with a number greater than 1 is not supported by OPA5",this);return z.apply(f.history,arguments);};}function v(){e.remove();f=null;F=null;o=null;d=null;}$(function(){e=$("#OpaFrame");e.on("load",k);$("body").height("100%");$("html").height("100%");});return h;},true);
